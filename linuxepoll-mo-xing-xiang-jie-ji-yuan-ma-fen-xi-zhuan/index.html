<!DOCTYPE HTML>
<html lang="ch">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Linux epoll模型详解及源码分析 ( 转), BanThink 纯粹写写文字的地方~">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Linux epoll模型详解及源码分析 ( 转) | BanThink 纯粹写写文字的地方~</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="BanThink 纯粹写写文字的地方~" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">BanThink 纯粹写写文字的地方~</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">BanThink 纯粹写写文字的地方~</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/17.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Linux epoll模型详解及源码分析 ( 转)</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">No tag</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%90%8E%E5%8F%B0%E5%BC%80%E5%8F%91/" class="post-category">
                                后台开发
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2020-02-02
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>转载自 <a target="_blank" rel="noopener" href="https://blog.csdn.net/zhaobryant/article/details/80557262">CSDN Linux epoll模型详解及源码分析</a></p>
</blockquote>
<h1 id="epoll简介"><a href="#epoll简介" class="headerlink" title="epoll简介"></a>epoll简介</h1><p>epoll是当前在Linux下开发大规模并发网络程序的热门选择，epoll在Linux2.6内核中正式引入，和select相似，都是IO多路复用（IO multiplexing）技术。</p>
<h1 id="EPOLL-特点"><a href="#EPOLL-特点" class="headerlink" title="EPOLL 特点"></a>EPOLL 特点</h1><h2 id="支持一个进程打开较大数目的文件描述符（fd）"><a href="#支持一个进程打开较大数目的文件描述符（fd）" class="headerlink" title="支持一个进程打开较大数目的文件描述符（fd）"></a>支持一个进程打开较大数目的文件描述符（fd）</h2><p>select模型对一个进程所打开的文件描述符是有一定限制的，其由FD_SETSIZE设置，默认为1024/2048。这对于那些需要支持上万连接数目的高并发服务器来说显然太少了，这个时候，可以选择两种方案：一是可以选择修改FD_SETSIZE宏然后重新编译内核，不过这样做也会带来网络效率的下降；二是可以选择多进程的解决方案（传统的Apache方案），不过虽然Linux中创建线程的代价比较小，但仍然是不可忽视的，加上进程间数据同步远不及线程间同步的高效，所以也不是一种完美的方案。</p>
<p>但是，epoll则没有对描述符数目的限制，它所支持的文件描述符上限是整个系统最大可以打开的文件数目，例如，在1GB内存的机器上，这个限制大概为10万左右。</p>
<h2 id="IO效率不会随文件描述符（fd）的增加而线性下降"><a href="#IO效率不会随文件描述符（fd）的增加而线性下降" class="headerlink" title="IO效率不会随文件描述符（fd）的增加而线性下降"></a>IO效率不会随文件描述符（fd）的增加而线性下降</h2><p>传统的select/poll的一个致命弱点就是当你拥有一个很大的socket集合时，不过任一时间只有部分socket是活跃的，select/poll每次调用都会线性扫描整个socket集合，这将导致IO处理效率呈现线性下降。</p>
<p>但是，epoll不存在这个问题，它只会对活跃的socket进行操作，这是因为在内核实现中，epoll是根据每个fd上面的callback函数实现的。因此，只有活跃的socket才会主动去调用callback函数，其他idle状态socket则不会。在这一点上，epoll实现了一个伪AIO，其内部推动力在内核。</p>
<p>在一些benchmark中，如果所有的socket基本上都是活跃的，如高速LAN环境，epoll并不比select/poll效率高，相反，过多使用epoll_ctl，其效率反而还有稍微下降。但是，一旦使用idle connections模拟WAN环境，epoll的效率就远在select/poll之上了。</p>
<h2 id="使用mmap加速内核与用户空间的消息传递"><a href="#使用mmap加速内核与用户空间的消息传递" class="headerlink" title="使用mmap加速内核与用户空间的消息传递"></a>使用mmap加速内核与用户空间的消息传递</h2><p>无论是select，poll还是epoll，它们都需要内核把fd消息通知给用户空间。因此，如何避免不必要的内存拷贝就很重要了。对于该问题，epoll通过内核与用户空间mmap(映射)同一块内存来实现。</p>
<h2 id="内核微调"><a href="#内核微调" class="headerlink" title="内核微调"></a>内核微调</h2><p>这一点其实不算epoll的优点了，而是整个Linux平台的优点，Linux赋予开发者微调内核的能力。比如，内核TCP/IP协议栈使用内存池管理sk_buff结构，那么，可以在运行期间动态调整这个内存池大小（skb_head_pool）来提高性能，该参数可以通过使用echo xxxx &gt; /proc/sys/net/core/hot_list_length来完成。再如，可以尝试使用最新的NAPI网卡驱动架构来处理数据包数量巨大但数据包本身很小的特殊场景。</p>
<h1 id="epoll-API"><a href="#epoll-API" class="headerlink" title="epoll API"></a>epoll API</h1><p>epoll只有epoll_create、epoll_ctl和epoll_wait这三个系统调用。其定义如下：</p>
<pre class="line-numbers language-none"><code class="language-none"># include &lt;sys/epoll.h&gt;

int epoll_create(int size);

int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);

int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="epoll-create"><a href="#epoll-create" class="headerlink" title="epoll_create"></a>epoll_create</h2><p>int epoll_create(int size);</p>
<p>可以调用epoll_create方法创建一个epoll的句柄。</p>
<p>需要注意的是，当创建好epoll句柄后，它就会占用一个fd值。在使用完epoll后，必须调用close函数进行关闭，否则可能导致fd被耗尽。</p>
<h2 id="epoll-ctl"><a href="#epoll-ctl" class="headerlink" title="epoll_ctl"></a>epoll_ctl</h2><p>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);</p>
<p>epoll的事件注册函数，它不同于select是在监听事件时告诉内核要监听什么类型的事件，而是通过epoll_ctl注册要监听的事件类型。</p>
<p>第一个参数epfd：epoll_create函数的返回值。</p>
<p>第二个参数events：表示动作类型。有三个宏来表示：</p>
<ul>
<li>EPOLL_CTL_ADD：注册新的fd到epfd中；</li>
<li>EPOLL_CTL_MOD：修改已经注册的fd的监听事件；</li>
<li>EPOLL_CTL_DEL：从epfd中删除一个fd。</li>
</ul>
<p>第三个参数fd：需要监听的fd。</p>
<p>第四个参数event：告诉内核需要监听什么事件。</p>
<p>struct epoll_event结构如下所示：</p>
<pre class="line-numbers language-none"><code class="language-none">// 保存触发事件的某个文件描述符相关的数据
typedef union epoll_data {
    void *ptr;
    int fd;
    __uint32_t u32;
    __uint64_t u64;
} epoll_data_t;


// 感兴趣的事件和被触发的事件
struct epoll_event {
    __uint32_t events; // Epoll events
    epoll_data_t data; // User data variable
};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>如上所示，对于Epoll Events，其可以是以下几个宏的集合：</p>
<p>EPOLLIN：表示对应的文件描述符可读（包括对端Socket）；</p>
<p>EPOLLOUT：表示对应的文件描述符可写；</p>
<p>EPOLLPRI：表示对应的文件描述符有紧急数据可读（带外数据）；</p>
<p>EPOLLERR：表示对应的文件描述符发生错误；</p>
<p>EPOLLHUP：表示对应的文件描述符被挂断；</p>
<p>EPOLLET：将EPOLL设为边缘触发（Edge Triggered），这是相对于水平触发（Level Triggered）而言的。</p>
<p>EPOLLONESHOT：只监听一次事件，当监听完这次事件之后，如果还需要继续监听这个socket，需要再次</p>
<h1 id="epoll-wait"><a href="#epoll-wait" class="headerlink" title="epoll_wait"></a>epoll_wait</h1><p>int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);</p>
<p>收集在epoll监控的事件中已经发生的事件。参数events是分配好的epoll_event结构体数组，epoll将会把发生的事件赋值到events数组中（events不可以是空指针，内核只负责把数据赋值到这个event数组中，不会去帮助我们在用户态分配内存）。maxevents告诉内核这个events数组有多大，这个maxevents的值不能大于创建epoll_create时的size。参数timeout是超时时间（毫秒）。如果函数调用成功，则返回对应IO上已准备好的文件描述符数目，如果返回0则表示已经超时。</p>
<h1 id="epoll工作模式"><a href="#epoll工作模式" class="headerlink" title="epoll工作模式"></a>epoll工作模式</h1><h2 id="LT模式（Level-Triggered，水平触发）"><a href="#LT模式（Level-Triggered，水平触发）" class="headerlink" title="LT模式（Level Triggered，水平触发）"></a>LT模式（Level Triggered，水平触发）</h2><p>该模式是epoll的缺省工作模式，其同时支持阻塞和非阻塞socket。内核会告诉开发者一个文件描述符是否就绪，如果开发者不采取任何操作，内核仍会一直通知。</p>
<h2 id="ET模式（Edge-Triggered，边缘触发）"><a href="#ET模式（Edge-Triggered，边缘触发）" class="headerlink" title="ET模式（Edge Triggered，边缘触发）"></a>ET模式（Edge Triggered，边缘触发）</h2><p>该模式是一种高速处理模式，当且仅当状态发生变化时才会获得通知。在该模式下，其假定开发者在接收到一次通知后，会完整地处理该事件，因此内核将不再通知这一事件。注意，缓冲区中还有未处理的数据不能说是状态变化，因此，在ET模式下，开发者如果只读取了一部分数据，其将再也得不到通知了。正确的做法是，开发者自己确认读完了所有的字节（一直调用read/write直到出错EAGAGIN为止）。</p>
<p>Nginx默认采用的就是ET（边缘触发）。</p>
<h1 id="epoll高效性探讨"><a href="#epoll高效性探讨" class="headerlink" title="epoll高效性探讨"></a>epoll高效性探讨</h1><p>epoll的高效性主要体现在以下三个方面：</p>
<p>（1）select/poll每次调用都要传递所要监控的所有fd给select/poll系统调用，这意味着每次调用select/poll时都要将fd列表从用户空间拷贝到内核，当fd数目很多时，这会造成性能低效。对于epoll_wait，每次调用epoll_wait时，其不需要将fd列表传递给内核，epoll_ctl不需要每次都拷贝所有的fd列表，只需要进行增量式操作。因此，在调用epoll_create函数之后，内核已经在内核开始准备数据结构用于存放需要监控的fd了。其后，每次epoll_ctl只是对这个数据结构进行简单的维护操作即可。</p>
<p>（2）内核使用slab机制，为epoll提供了快速的数据结构。在内核里，一切都是文件。因此，epoll向内核注册了一个文件系统，用于存储所有被监控的fd。当调用epoll_create时，就会在这个虚拟的epoll文件系统中创建一个file节点。epoll在被内核初始化时，同时会分配出epoll自己的内核告诉cache区，用于存放每个我们希望监控的fd。这些fd会以红黑树的形式保存在内核cache里，以支持快速查找、插入和删除。这个内核高速cache，就是建立连续的物理内存页，然后在之上建立slab层，简单的说，就是物理上分配好想要的size的内存对象，每次使用时都使用空闲的已分配好的对象。</p>
<p>（3）当调用epoll_ctl往epfd注册百万个fd时，epoll_wait仍然能够快速返回，并有效地将发生的事件fd返回给用户。原因在于，当我们调用epoll_create时，内核除了帮我们在epoll文件系统新建file节点，同时在内核cache创建红黑树用于存储以后由epoll_ctl传入的fd外，还会再建立一个list链表，用于存储准备就绪的事件。当调用epoll_wait时，仅仅观察这个list链表中有无数据即可。如果list链表中有数据，则返回这个链表中的所有元素；如果list链表中没有数据，则sleep然后等到timeout超时返回。所以，epoll_wait非常高效，而且，通常情况下，即使我们需要监控百万计的fd，但大多数情况下，一次也只返回少量准备就绪的fd而已。因此，每次调用epoll_wait，其仅需要从内核态复制少量的fd到用户空间而已。那么，这个准备就绪的list链表是怎么维护的呢？过程如下：当我们执行epoll_ctl时，除了把fd放入到epoll文件系统里file对象对应的红黑树之外，还会给内核中断处理程序注册一个回调函数，其告诉内核，如果这个fd的中断到了，就把它放到准备就绪的list链表中。</p>
<p>如此，一棵红黑树、一张准备就绪的fd链表以及少量的内核cache，就帮我们解决了高并发下fd的处理问题。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>执行epoll_create时，创建了红黑树和就绪list链表；</p>
<p>执行epoll_ctl时，如果增加fd，则检查在红黑树中是否存在，存在则立即返回，不存在则添加到红黑树<br>中，然后向内核注册回调函数，用于当中断事件到来时向准备就绪的list链表中插入数据。</p>
<p>执行epoll_wait时立即返回准备就绪链表里的数据即可。</p>
<h1 id="epoll源码分析"><a href="#epoll源码分析" class="headerlink" title="epoll源码分析"></a>epoll源码分析</h1><p>eventpoll_init过程：</p>
<pre class="line-numbers language-none"><code class="language-none">static int __init eventpoll_init(void)
{
    int error;

    init_MUTEX(&amp;epsem);

    /* Initialize the structure used to perform safe poll wait head wake ups */
    ep_poll_safewake_init(&amp;psw);

    /* Allocates slab cache used to allocate "struct epitem" items */
    epi_cache = kmem_cache_create("eventpoll_epi", sizeof(struct epitem),
            0, SLAB_HWCACHE_ALIGN|EPI_SLAB_DEBUG|SLAB_PANIC,
            NULL, NULL);

    /* Allocates slab cache used to allocate "struct eppoll_entry" */
    pwq_cache = kmem_cache_create("eventpoll_pwq",
            sizeof(struct eppoll_entry), 0,
            EPI_SLAB_DEBUG|SLAB_PANIC, NULL, NULL);

    /*
     * Register the virtual file system that will be the source of inodes
     * for the eventpoll files
     */
    error = register_filesystem(&amp;eventpoll_fs_type);
    if (error)
        goto epanic;

    /* Mount the above commented virtual file system */
    eventpoll_mnt = kern_mount(&amp;eventpoll_fs_type);
    error = PTR_ERR(eventpoll_mnt);
    if (IS_ERR(eventpoll_mnt))
        goto epanic;

    DNPRINTK(3, (KERN_INFO "[%p] eventpoll: successfully initialized.\n",
            current));
    return 0;

epanic:
    panic("eventpoll_init() failed\n");
}
1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>其中，epoll用slab分配器kmem_cache_create分配内存用于存放struct epitem和struct eppoll_entry。</p>
<p>当向系统中添加一个fd时，就会创建一个epitem结构体，这是内核管理epoll的基本数据结构：</p>
<p>````<br>/*</p>
<ul>
<li><p>Each file descriptor added to the eventpoll interface will</p>
</li>
<li><p>have an entry of this type linked to the hash.</p>
</li>
<li><p>/<br>struct epitem {<br>   /* RB-Tree node used to link this structure to the eventpoll rb-tree */<br>   struct rb_node rbn;   // 用于主结构管理的红黑树</p>
<p>   /* List header used to link this structure to the eventpoll ready list */<br>   struct list_head rdllink;  // 事件就绪队列</p>
<p>   /* The file descriptor information this item refers to */<br>   struct epoll_filefd ffd; // 用于主结构中的链表</p>
<p>   /* Number of active wait queue attached to poll operations */<br>   int nwait; // 事件个数</p>
<p>   /* List containing poll wait queues */<br>   struct list_head pwqlist; // 双向链表，保存着被监控文件的等待队列</p>
<p>   /* The “container” of this item */<br>   struct eventpoll *ep;  // 该项属于哪个主结构体</p>
<p>   /* The structure that describe the interested events and the source fd */<br>   struct epoll_event event; // 注册的感兴趣的时间</p>
<p>   /*</p>
<pre><code>* Used to keep track of the usage count of the structure. This avoids
* that the structure will desappear from underneath our processing.
*/
</code></pre>
<p>   atomic_t usecnt;</p>
<p>   /* List header used to link this item to the “struct file” items list */<br>   struct list_head fllink;</p>
<p>   /* List header used to link the item to the transfer list */<br>   struct list_head txlink;</p>
<p>   /*</p>
<pre><code>* This is used during the collection/transfer of events to userspace
* to pin items empty events set.
*/
</code></pre>
<p>   unsigned int revents;<br>};</p>
<pre class="line-numbers language-none"><code class="language-none">
对于每个epfd，其对应的数据结构为：<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>/*</p>
</li>
<li><p>This structure is stored inside the “private_data” member of the file</p>
</li>
<li><p>structure and rapresent the main data sructure for the eventpoll</p>
</li>
<li><p>interface.</p>
</li>
<li><p>/<br>struct eventpoll {<br>   /* Protect the this structure access */<br>   rwlock_t lock;</p>
<p>   /*</p>
<pre><code>* This semaphore is used to ensure that files are not removed
* while epoll is using them. This is read-held during the event
* collection loop and it is write-held during the file cleanup
* path, the epoll file exit code and the ctl operations.
*/
</code></pre>
<p>   struct rw_semaphore sem;</p>
<p>   /* Wait queue used by sys_epoll_wait() */<br>   wait_queue_head_t wq;</p>
<p>   /* Wait queue used by file-&gt;poll() */<br>   wait_queue_head_t poll_wait;</p>
<p>   /* List of ready file descriptors */<br>   struct list_head rdllist;  // 准备就绪的事件链表</p>
<p>   /* RB-Tree root used to store monitored fd structs */<br>   struct rb_root rbr;   // 用于管理所有fd的红黑树（根节点）<br>};</p>
</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">
eventpoll在epoll_create时创建：<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>/*</p>
<ul>
<li><p>It opens an eventpoll file descriptor by suggesting a storage of “size”</p>
</li>
<li><p>file descriptors. The size parameter is just an hint about how to size</p>
</li>
<li><p>data structures. It won’t prevent the user to store more than “size”</p>
</li>
<li><p>file descriptors inside the epoll interface. It is the kernel part of</p>
</li>
<li><p>the userspace epoll_create(2).</p>
</li>
<li><p>/<br>asmlinkage long sys_epoll_create(int size)<br>{<br>   int error, fd;<br>   struct eventpoll *ep;<br>   struct inode *inode;<br>   struct file *file;</p>
<p>   DNPRINTK(3, (KERN_INFO “[%p] eventpoll: sys_epoll_create(%d)\n”,</p>
<pre><code>        current, size));
</code></pre>
<p>   /*</p>
<pre><code>* Sanity check on the size parameter, and create the internal data
* structure ( "struct eventpoll" ).
*/
</code></pre>
<p>   error = -EINVAL;<br>   if (size &lt;= 0 || (error = ep_alloc(&amp;ep)) != 0)  // ep_alloc为eventpoll分配内存并初始化</p>
<pre><code>   goto eexit_1;
</code></pre>
<p>   /*</p>
<pre><code>* Creates all the items needed to setup an eventpoll file. That is,
* a file structure, and inode and a free file descriptor.
*/
</code></pre>
<p>   error = ep_getfd(&amp;fd, &amp;inode, &amp;file, ep); // 创建于eventpoll相关的数据结构，包括file、inode和fd等信息<br>   if (error)</p>
<pre><code>   goto eexit_2;
</code></pre>
<p>   DNPRINTK(3, (KERN_INFO “[%p] eventpoll: sys_epoll_create(%d) = %d\n”,</p>
<pre><code>        current, size, fd));
</code></pre>
<p>   return fd;</p>
</li>
</ul>
<p>eexit_2:<br>    ep_free(ep);<br>    kfree(ep);<br>eexit_1:<br>    DNPRINTK(3, (KERN_INFO “[%p] eventpoll: sys_epoll_create(%d) = %d\n”,<br>             current, size, error));<br>    return error;<br>}</p>
<pre class="line-numbers language-none"><code class="language-none">

如上，内核中维护了一棵红黑树，大致结构如下：



下面是epoll_ctl函数过程：<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>/*</p>
<ul>
<li><p>The following function implements the controller interface for</p>
</li>
<li><p>the eventpoll file that enables the insertion/removal/change of</p>
</li>
<li><p>file descriptors inside the interest set.  It represents</p>
</li>
<li><p>the kernel part of the user space epoll_ctl(2).</p>
</li>
<li><p>/<br>asmlinkage long<br>sys_epoll_ctl(int epfd, int op, int fd, struct epoll_event __user *event)<br>{<br>   int error;<br>   struct file *file, *tfile;<br>   struct eventpoll *ep;<br>   struct epitem *epi;<br>   struct epoll_event epds;</p>
<p>   DNPRINTK(3, (KERN_INFO “[%p] eventpoll: sys_epoll_ctl(%d, %d, %d, %p)\n”,</p>
<pre><code>        current, epfd, op, fd, event));
</code></pre>
<p>   error = -EFAULT;<br>   if (ep_op_hash_event(op) &amp;&amp;</p>
<pre><code>   copy_from_user(&amp;epds, event, sizeof(struct epoll_event)))
   goto eexit_1;
</code></pre>
<p>   /* Get the “struct file *” for the eventpoll file */<br>   error = -EBADF;<br>   file = fget(epfd);  // 获取epfd对应的文件<br>   if (!file)</p>
<pre><code>   goto eexit_1;
</code></pre>
<p>   /* Get the “struct file *” for the target file */<br>   tfile = fget(fd);  // 获取fd对应的文件<br>   if (!tfile)</p>
<pre><code>   goto eexit_2;
</code></pre>
<p>   /* The target file descriptor must support poll */<br>   error = -EPERM;<br>   if (!tfile-&gt;f_op || !tfile-&gt;f_op-&gt;poll)</p>
<pre><code>   goto eexit_3;
</code></pre>
<p>   /*</p>
<pre><code>* We have to check that the file structure underneath the file descriptor
* the user passed to us _is_ an eventpoll file. And also we do not permit
* adding an epoll file descriptor inside itself.
*/
</code></pre>
<p>   error = -EINVAL;<br>   if (file == tfile || !is_file_epoll(file))</p>
<pre><code>   goto eexit_3;
</code></pre>
<p>   /*</p>
<pre><code>* At this point it is safe to assume that the "private_data" contains
* our own data structure.
*/
</code></pre>
<p>   ep = file-&gt;private_data;</p>
<p>   down_write(&amp;ep-&gt;sem);</p>
<p>   /* Try to lookup the file inside our hash table */<br>   epi = ep_find(ep, tfile, fd);  // 在哈希表中查询，防止重复添加</p>
<p>   error = -EINVAL;<br>   switch (op) {<br>   case EPOLL_CTL_ADD:  // 添加节点，调用ep_insert函数</p>
<pre><code>   if (!epi) {
       epds.events |= POLLERR | POLLHUP;

       error = ep_insert(ep, &amp;epds, tfile, fd);
   } else
       error = -EEXIST;
   break;
</code></pre>
<p>   case EPOLL_CTL_DEL:  // 删除节点，调用ep_remove函数</p>
<pre><code>   if (epi)
       error = ep_remove(ep, epi);
   else
       error = -ENOENT;
   break;
</code></pre>
<p>   case EPOLL_CTL_MOD:  // 修改节点，调用ep_modify函数</p>
<pre><code>   if (epi) {
       epds.events |= POLLERR | POLLHUP;
       error = ep_modify(ep, epi, &amp;epds);
   } else
       error = -ENOENT;
   break;
</code></pre>
<p>   }</p>
<p>   /*</p>
<pre><code>* The function ep_find() increments the usage count of the structure
* so, if this is not NULL, we need to release it.
*/
</code></pre>
<p>   if (epi)</p>
<pre><code>   ep_release_epitem(epi);
</code></pre>
<p>   up_write(&amp;ep-&gt;sem);</p>
</li>
</ul>
<p>eexit_3:<br>    fput(tfile);<br>eexit_2:<br>    fput(file);<br>eexit_1:<br>    DNPRINTK(3, (KERN_INFO “[%p] eventpoll: sys_epoll_ctl(%d, %d, %d, %p) = %d\n”,<br>             current, epfd, op, fd, event, error));</p>
<pre><code>return error;
</code></pre>
<p>}</p>
<pre class="line-numbers language-none"><code class="language-none">
对于ep_insert函数，基本代码如下：
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>static int ep_insert(struct eventpoll *ep, struct epoll_event *event,<br>             struct file *tfile, int fd)<br>{<br>    int error, revents, pwake = 0;<br>    unsigned long flags;<br>    struct epitem *epi;<br>    struct ep_pqueue epq;</p>
<pre><code>error = -ENOMEM;
// 分配一个epitem结构体来保存每个加入的fd
if (!(epi = kmem_cache_alloc(epi_cache, SLAB_KERNEL)))
    goto eexit_1;

/* Item initialization follow here ... */
// 初始化结构体
ep_rb_initnode(&amp;epi-&gt;rbn);
INIT_LIST_HEAD(&amp;epi-&gt;rdllink);
INIT_LIST_HEAD(&amp;epi-&gt;fllink);
INIT_LIST_HEAD(&amp;epi-&gt;txlink);
INIT_LIST_HEAD(&amp;epi-&gt;pwqlist);
epi-&gt;ep = ep;
ep_set_ffd(&amp;epi-&gt;ffd, tfile, fd);
epi-&gt;event = *event;
atomic_set(&amp;epi-&gt;usecnt, 1);
epi-&gt;nwait = 0;

/* Initialize the poll table using the queue callback */
epq.epi = epi;
// 安装poll回调函数
init_poll_funcptr(&amp;epq.pt, ep_ptable_queue_proc);

/*
 * Attach the item to the poll hooks and get current event bits.
 * We can safely use the file* here because its usage count has
 * been increased by the caller of this function.
 */
// 将当前item添加至poll hook中，然后获取当前event位
revents = tfile-&gt;f_op-&gt;poll(tfile, &amp;epq.pt);

/*
 * We have to check if something went wrong during the poll wait queue
 * install process. Namely an allocation for a wait queue failed due
 * high memory pressure.
 */
if (epi-&gt;nwait &lt; 0)
    goto eexit_2;

/* Add the current item to the list of active epoll hook for this file */
spin_lock(&amp;tfile-&gt;f_ep_lock);
list_add_tail(&amp;epi-&gt;fllink, &amp;tfile-&gt;f_ep_links);
spin_unlock(&amp;tfile-&gt;f_ep_lock);

/* We have to drop the new item inside our item list to keep track of it */
write_lock_irqsave(&amp;ep-&gt;lock, flags);

/* Add the current item to the rb-tree */
ep_rbtree_insert(ep, epi);

/* If the file is already "ready" we drop it inside the ready list */
if ((revents &amp; event-&gt;events) &amp;&amp; !ep_is_linked(&amp;epi-&gt;rdllink)) {
    list_add_tail(&amp;epi-&gt;rdllink, &amp;ep-&gt;rdllist);

    /* Notify waiting tasks that events are available */
    if (waitqueue_active(&amp;ep-&gt;wq))
        wake_up(&amp;ep-&gt;wq);
    if (waitqueue_active(&amp;ep-&gt;poll_wait))
        pwake++;
}

write_unlock_irqrestore(&amp;ep-&gt;lock, flags);

/* We have to call this outside the lock */
if (pwake)
    ep_poll_safewake(&amp;psw, &amp;ep-&gt;poll_wait);

DNPRINTK(3, (KERN_INFO "[%p] eventpoll: ep_insert(%p, %p, %d)\n",
         current, ep, tfile, fd));

return 0;
</code></pre>
<p>eexit_2:<br>    ep_unregister_pollwait(ep, epi);</p>
<pre><code>/*
 * We need to do this because an event could have been arrived on some
 * allocated wait queue.
 */
write_lock_irqsave(&amp;ep-&gt;lock, flags);
if (ep_is_linked(&amp;epi-&gt;rdllink))
    ep_list_del(&amp;epi-&gt;rdllink);
write_unlock_irqrestore(&amp;ep-&gt;lock, flags);

kmem_cache_free(epi_cache, epi);
</code></pre>
<p>eexit_1:<br>    return error;<br>}</p>
<pre class="line-numbers language-none"><code class="language-none">
其中，init_poll_funcptr和tfile-&gt;f_op-&gt;poll将ep_ptable_queue_proc注册到epq.pt中的qproc中。

ep_ptable_queue_proc函数设置了等待队列的ep_poll_callback回调函数。在设备硬件数据到来时，硬件中断函数唤醒该等待队列上等待的进程时，会调用唤醒函数ep_poll_callback。

ep_poll_callback函数主要的功能是将被监视文件的等待事件就绪时，将文件对应的epitem实例添加到就绪队列中，当用户调用epoll_wait时，内核会将就绪队列中的事件报告给用户。

epoll_wait的实现如下：
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>/*</p>
<ul>
<li><p>Implement the event wait interface for the eventpoll file. It is the kernel</p>
</li>
<li><p>part of the user space epoll_wait(2).</p>
</li>
<li><p>/<br>asmlinkage long sys_epoll_wait(int epfd, struct epoll_event __user *events,</p>
<pre><code>              int maxevents, int timeout)
</code></pre>
<p>{<br>   int error;<br>   struct file *file;<br>   struct eventpoll *ep;</p>
<p>   DNPRINTK(3, (KERN_INFO “[%p] eventpoll: sys_epoll_wait(%d, %p, %d, %d)\n”,</p>
<pre><code>        current, epfd, events, maxevents, timeout));
</code></pre>
<p>   /* The maximum number of event must be greater than zero */<br>   if (maxevents &lt;= 0 || maxevents &gt; MAX_EVENTS) // 检查maxevents参数</p>
<pre><code>   return -EINVAL;
</code></pre>
<p>   /* Verify that the area passed by the user is writeable */<br>   // 检查用户空间传入的events指向的内存是否可写<br>   if (!access_ok(VERIFY_WRITE, events, maxevents * sizeof(struct epoll_event))) {</p>
<pre><code>   error = -EFAULT;
   goto eexit_1;
</code></pre>
<p>   }</p>
<p>   /* Get the “struct file *” for the eventpoll file */<br>   error = -EBADF;<br>   file = fget(epfd); // 获取epfd对应的eventpoll文件的file实例，file结构是在epoll_create中创建的<br>   if (!file)</p>
<pre><code>   goto eexit_1;
</code></pre>
<p>   /*</p>
<pre><code>* We have to check that the file structure underneath the fd
* the user passed to us _is_ an eventpoll file.
*/
</code></pre>
<p>   error = -EINVAL;<br>   if (!is_file_epoll(file))</p>
<pre><code>   goto eexit_2;
</code></pre>
<p>   /*</p>
<pre><code>* At this point it is safe to assume that the "private_data" contains
* our own data structure.
*/
</code></pre>
<p>   ep = file-&gt;private_data;</p>
<p>   /* Time to fish for events … */<br>   // 核心处理函数<br>   error = ep_poll(ep, events, maxevents, timeout);</p>
</li>
</ul>
<p>eexit_2:<br>    fput(file);<br>eexit_1:<br>    DNPRINTK(3, (KERN_INFO “[%p] eventpoll: sys_epoll_wait(%d, %p, %d, %d) = %d\n”,<br>             current, epfd, events, maxevents, timeout, error));</p>
<pre><code>return error;
</code></pre>
<p>}</p>
<pre class="line-numbers language-none"><code class="language-none">
其中，调用ep_poll函数，具体流程如下：
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>static int ep_poll(struct eventpoll *ep, struct epoll_event __user *events,<br>           int maxevents, long timeout)<br>{<br>    int res, eavail;<br>    unsigned long flags;<br>    long jtimeout;<br>    wait_queue_t wait;</p>
<pre><code>/*
 * Calculate the timeout by checking for the "infinite" value ( -1 )
 * and the overflow condition. The passed timeout is in milliseconds,
 * that why (t * HZ) / 1000.
 */
jtimeout = (timeout &lt; 0 || timeout &gt;= EP_MAX_MSTIMEO) ?
    MAX_SCHEDULE_TIMEOUT : (timeout * HZ + 999) / 1000;
</code></pre>
<p>retry:<br>    write_lock_irqsave(&amp;ep-&gt;lock, flags);</p>
<pre><code>res = 0;
if (list_empty(&amp;ep-&gt;rdllist)) {
    /*
     * We don't have any available event to return to the caller.
     * We need to sleep here, and we will be wake up by
     * ep_poll_callback() when events will become available.
     */
    init_waitqueue_entry(&amp;wait, current);
    add_wait_queue(&amp;ep-&gt;wq, &amp;wait);

    for (;;) {
        /*
         * We don't want to sleep if the ep_poll_callback() sends us
         * a wakeup in between. That's why we set the task state
         * to TASK_INTERRUPTIBLE before doing the checks.
         */
        set_current_state(TASK_INTERRUPTIBLE);
        if (!list_empty(&amp;ep-&gt;rdllist) || !jtimeout)
            break;
        if (signal_pending(current)) {
            res = -EINTR;
            break;
        }

        write_unlock_irqrestore(&amp;ep-&gt;lock, flags);
        jtimeout = schedule_timeout(jtimeout);
        write_lock_irqsave(&amp;ep-&gt;lock, flags);
    }
    remove_wait_queue(&amp;ep-&gt;wq, &amp;wait);

    set_current_state(TASK_RUNNING);
}

/* Is it worth to try to dig for events ? */
eavail = !list_empty(&amp;ep-&gt;rdllist);

write_unlock_irqrestore(&amp;ep-&gt;lock, flags);

/*
 * Try to transfer events to user space. In case we get 0 events and
 * there's still timeout left over, we go trying again in search of
 * more luck.
 */
if (!res &amp;&amp; eavail &amp;&amp;
    !(res = ep_events_transfer(ep, events, maxevents)) &amp;&amp; jtimeout)
    goto retry;

return res;
</code></pre>
<p>}</p>
<p>```</p>
<p>ep_send_events函数用于向用户空间发送就绪事件。ep_send_events函数将用户传入的内存简单封装到ep_send_events_data结构中，然后调用ep_scan_ready_list将就绪队列中的事件传入用户空间的内存。</p>
<p>六、参考<br>Epoll详解及源码分析——CSDN博客</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Skykens</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://example.com/linuxepoll-mo-xing-xiang-jie-ji-yuan-ma-fen-xi-zhuan/">http://example.com/linuxepoll-mo-xing-xiang-jie-ji-yuan-ma-fen-xi-zhuan/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint policy. If reproduced, please indicate source
                    <a href="/about" target="_blank">Skykens</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">No tag</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/tong-guo-leetcode-lai-liao-jie-hui-su-suan-fa/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="通过LeetCode来了解   回溯算法">
                        
                        <span class="card-title">通过LeetCode来了解   回溯算法</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-02-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%AE%97%E6%B3%95/" class="post-category">
                                    算法
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/shen-ru-li-jie-select-mo-xing-yuan-ma-fen-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="深入理解select 模型     （源码分析 ）">
                        
                        <span class="card-title">深入理解select 模型     （源码分析 ）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-02-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%90%8E%E5%8F%B0%E5%BC%80%E5%8F%91/" class="post-category">
                                    后台开发
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: BanThink 纯粹写写文字的地方~<br />'
            + 'Author: Skykens<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">Skykens</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2019";
                    var startMonth = "7";
                    var startDate = "10";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/skykens" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:470798745@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=4700798745" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 4700798745" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2019, 07, 10, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " +diffYears+" 年 "+diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
